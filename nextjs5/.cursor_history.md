# 请假申请工作流系统开发总结

## 会话的主要目的
开发一个完整的请假申请工作流系统，包括前端可视化工作流界面和后端工作流引擎处理。实现阶梯式工作流图布局，从高到低排列各个审批模块。

## 完成的主要任务

### 1. 数据库设计
- 更新了Prisma schema，添加了请假工作流相关的数据模型
- 创建了用户表、请假申请表、工作流实例表和工作流步骤记录表
- 建立了正确的表关系和外键约束

### 2. 前端工作流界面 (pages/Flow.tsx)
- 使用React Flow库创建了可视化的工作流界面
- 实现了请假申请表单、申请列表和工作流图展示
- 支持两种工作流类型：
  - 简单流程：≤3天，主管审批即可
  - 复杂流程：>3天，需要主管+董事长双重审批
- 自定义了三种节点类型：开始节点、审批节点、结束节点
- 实现了实时工作流状态更新和可视化展示
- **新增功能**：阶梯式工作流图布局，从高到低排列各个审批模块，提供更直观的流程展示

### 3. 后端工作流API
- 使用Zeebe工作流引擎作为第三方工作流框架
- 实现了完整的请假申请CRUD操作
- 支持工作流实例的创建和管理
- 实现了审批流程的状态管理和步骤记录
- 支持BPMN工作流定义的部署和执行

#### API路由结构（已修复）
- `POST /api/flow/init` - 初始化用户数据
- `POST /api/flow/leave-request` - 提交请假申请
- `GET /api/flow/leave-requests` - 获取请假申请列表
- `POST /api/flow/approve` - 审批请假申请

### 4. 数据初始化API (app/api/flow/init/route.ts)
- 创建了用户数据初始化接口
- 预设了三个用户角色：员工张三、主管李四、董事长王五

## 关键决策和解决方案

### 1. 技术栈选择
- **前端工作流引擎**：React Flow - 提供强大的可视化工作流编辑和展示能力
- **后端工作流引擎**：Zeebe - 企业级工作流引擎，支持BPMN标准
- **数据库ORM**：Prisma - 类型安全的数据库操作
- **数据库**：SQLite - 轻量级，适合开发和测试

### 2. 工作流布局设计
- **阶梯式布局**：采用从高到低的阶梯式排列，让工作流图更加直观
- **位置优化**：开始模块(y:50) → 主管模块(y:150) → 董事长模块(y:250) → 结束模块(y:250/350)
- **视觉层次**：通过垂直位置差异清晰展示审批流程的层级关系

### 3. 工作流设计
- 采用条件分支设计，根据请假天数自动选择工作流类型
- 实现了状态机模式，每个审批步骤都有明确的状态转换
- 支持工作流实例的完整生命周期管理

### 4. 架构设计
- 前后端分离，API驱动
- 数据库设计规范化，支持复杂的工作流关系
- 错误处理和状态管理完善

### 5. API路由问题修复
- **问题**：初始的API路由结构不符合Next.js 13+ App Router规范
- **解决方案**：重新组织API路由结构，为每个端点创建独立的目录和route.ts文件
- **结果**：所有API端点现在都能正常工作，返回正确的响应

## 使用的技术栈

### 前端
- React 19.1.0
- Next.js 15.5.0
- React Flow 11.11.4 (工作流可视化)
- Tailwind CSS 4 (样式)
- TypeScript 5

### 后端
- Next.js API Routes (App Router)
- Prisma 6.11.1 (数据库ORM)
- Zeebe Node 8.3.2 (工作流引擎)
- SQLite (数据库)

### 开发工具
- pnpm (包管理器)
- ESLint (代码检查)

## 修改的文件

1. **schema.prisma** - 数据库模型定义
2. **pages/Flow.tsx** - 前端工作流界面
3. **app/api/flow/init/route.ts** - 数据初始化API
4. **app/api/flow/leave-request/route.ts** - 请假申请API
5. **app/api/flow/leave-requests/route.ts** - 请假申请列表API
6. **app/api/flow/approve/route.ts** - 审批API
7. **package.json** - 添加了工作流相关依赖
8. **test_api.js** - API测试脚本

## 系统功能特性

### 请假申请流程
- 员工提交请假申请（姓名、天数、原因）
- 系统自动判断工作流类型
- 主管审批（≤3天直接完成，>3天继续流转）
- 董事长审批（仅>3天需要）
- 完整的状态跟踪和记录

### 工作流可视化
- 实时显示当前工作流状态
- 支持工作流图的交互操作
- 清晰展示审批流程和责任人
- **新增功能**：工作流图区域添加"刷新数据"按钮，可手动刷新请假申请数据和工作流状态
- **阶梯式布局**：工作流图采用从高到低的阶梯式排列，开始模块在最上方，结束模块在最下方，提供更直观的流程展示

### 审批管理
- 支持多级审批流程
- 完整的审批历史记录
- 灵活的状态管理

## 部署和运行说明

1. 安装依赖：`pnpm install`
2. 初始化数据库：`pnpm run dev:push`
3. 启动开发服务器：`pnpm run dev`
4. 访问工作流界面：`http://localhost:60001/Flow`
5. 初始化用户数据：调用 `/api/flow/init` 接口

## 测试验证

### API测试
- ✅ 初始化API：`POST /api/flow/init`
- ✅ 请假申请API：`POST /api/flow/leave-request`
- ✅ 申请列表API：`GET /api/flow/leave-requests`
- ✅ 审批API：`POST /api/flow/approve`

### 功能测试
- ✅ 用户数据初始化
- ✅ 请假申请提交
- ✅ 工作流实例创建
- ✅ 审批流程执行

## 注意事项

- Zeebe工作流引擎需要单独部署（默认端口26500）
- 首次使用需要初始化用户数据
- 工作流状态变更会实时反映在前端界面
- 支持工作流的暂停、恢复和错误处理
- API路由结构已修复，符合Next.js 13+规范

## 问题解决记录

### 2024-01-XX API路由404错误修复
- **问题描述**：前端调用API时出现404错误，无法找到对应的端点
- **原因分析**：API路由文件结构不符合Next.js 13+ App Router规范
- **解决方案**：重新组织API路由结构，为每个端点创建独立的目录和route.ts文件
- **修复结果**：所有API端点现在都能正常工作，系统功能完整

### 2024-01-XX 工作流图阶梯式布局优化
- **需求描述**：用户希望工作流图采用阶梯式布局，从高到低排列各个审批模块
- **解决方案**：修改 `create_workflow` 函数中的节点位置设置，实现阶梯式垂直布局
- **布局效果**：
  - 开始模块：y:50（最高位置）
  - 主管模块：y:150（第二层）
  - 董事长模块：y:250（第三层）
  - 结束模块：y:250/350（最低位置）
- **优化结果**：工作流图现在呈现清晰的阶梯式布局，审批流程的层级关系更加直观

### 2024-01-XX 状态管理重构：从useState到valtio
- **需求描述**：用户希望将代码从useState状态管理重构为valtio全局状态管理
- **解决方案**：
  - 安装valtio包：`pnpm add valtio`
  - 创建全局状态store，使用proxy包装状态对象
  - 使用useSnapshot钩子获取状态快照
  - 直接修改state对象来更新状态，无需setter函数
- **重构内容**：
  - 移除了所有useState调用
  - 创建了包含leave_requests、selected_request、form_data、workflow_window的全局状态
  - 更新了所有状态操作，从setter函数改为直接赋值
  - 保持了原有的功能逻辑不变
- **技术优势**：
  - 更简洁的状态管理代码
  - 更好的性能（避免不必要的重渲染）
  - 全局状态共享，便于跨组件通信
  - 类型安全的状态操作
- **修改文件**：pages/Flow.tsx

---

*本文档内容会随着会话的进行而累积增加，记录项目的完整开发历程。* 